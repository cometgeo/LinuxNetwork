## Part 1. Инструмент ipcalc
### 1.1. Сети и маски
1) Адрес сети 192.167.38.54/13 - <span style="color:#ccff33">192.160.0.0  

![](img/part1/Screenshot%202024-07-04%20at%2016.38.48.png)  
2) Перевод маски 255.255.255.0 в префиксную и двоичную запись, /15 в обычную и двоичную, 11111111.11111111.11111111.11110000 в обычную и префиксную
- `255.255.255.0`  
- `префиксная /24`  
- `двоичная 11111111.11111111.11111111. 00000000`
![](img/part1/Screenshot%202024-07-04%20at%2016.40.41.png)
___
- `/15`
- `обычная 255.254.0.0`
- `двоичная 111111111.1111111111.00000000.00000000`
![](img/part1/Screenshot%202024-07-04%20at%2016.41.44.png)
---
- `11111111.11111111.11111111.11110000`
- `обычная 255.255.255.240`
- `префиксная /28`  
![](img/part1/Screenshot%202024-07-04%20at%2016.46.30.png)
---
3) Минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4  
- `12.167.38.4/8: минимальный - 12.0.0.1 максимальный - 12.255.255.254  `
- `12.167.38.4/16: минимальный - 12.167.0.1 максимальный - 12.167.255.254  `
- `12.167.38.4/23: минимальный - 12.167.38.1 максимальный - 12.167.39.254  `
- `12.167.38.4/4: минимальный - 0.0.0.1 максимальный - 15.255.255.254  `
![](img/part1/Screenshot%202024-07-04%20at%2017.03.06.png)
### 1.2. localhost
Определи и запиши в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1
- `194.34.23.100 - нет`
- `127.0.0.2 - да`
- `127.1.0.1 - да`
- `128.0.0.1 - нет`  
![](img/part1/Screenshot%202024-07-04%20at%2017.17.39.png)
### 1.3. Диапазоны и сегменты сетей

1) Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1
- `Те IP у которых в графе Hosts/Net указано Private Internet можно использовать только в качестве частных, остальные соотвественно можно использовать в качестве публичных`  
![](img/part1/Screenshot%202024-07-04%20at%2017.27.40.png)
2) Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255
- `Смотрим диапазон и исходя из него возможные IP:`
- `10.10.0.2`
- `10.10.10.10`
- `10.10.1.255`  
![](img/part1/Screenshot%202024-07-04%20at%2017.35.16.png)
## Part 2. Статическая маршрутизация между двумя машинами

- `С помощью команды ip смотрим существующие сетевые интерфейсы на машинах ws1 ws2`
![](img/part2/Screenshot%202024-07-04%20at%2018.09.30.png)
---
![](img/part2/Screenshot%202024-07-04%20at%2018.14.02.png)
---

- `Опиcал сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задал следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12`

- `Выполнил команду netplan apply для перезапуска сервиса сети`  

![](img/part2/Screenshot%202024-07-05%20at%2014.08.55.png)


### 2.1. Добавление статического маршрута вручную

- `Добавил статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add`

- `Пропинговал соединение между машинами`

![](img/part2/Screenshot%202024-07-05%20at%2014.31.07.png)
### 2.2. Добавление статического маршрута с сохранением

- `Добавил статический маршрут от одной машины до другой с помощью файла /etc/netplan/00-installer-config.yaml`

![](img/part2/Screenshot%202024-07-05%20at%2018.02.17.png)

- `Пропинговал соединение между машинами`

![](img/part2/Screenshot%202024-07-05%20at%2018.07.35.png)

## Part 3. Утилита iperf3

### 3.1. Скорость соединения

  Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps  
- `8 Mbps = 1 MB/s`  
- `100 MB/s = 819200 Kbps`  
- `1 Gbps = 1024 Mbps`

### 3.2. Утилита iperf3

- `Измерил скорость соединения между ws1 и ws2`

![](img/part3/Screenshot%202024-07-05%20at%2018.25.49.png)

## Part 4. Сетевой экран

### 4.1. Утилита iptables

- `Создал файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2`
1) На ws1 применил стратегию, когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5).

1) На ws2 применил стратегию, когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5).

2) Открыл на машинах доступ для порта 22 (ssh) и порта 80 (http).

3) Запретил echo reply (машина не должна «пинговаться», т.е. должна быть блокировка на OUTPUT).

4) Разрешил echo reply (машина должна «пинговаться»).

![](img/part4/Screenshot%202024-07-05%20at%2019.52.31.png)

- `Запустил файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh`

![](img/part4/Screenshot%202024-07-05%20at%2019.17.41.png)

### 4.2. Утилита nmap

- `нашёл машину, которая не «пингуется», утилита nmap говорит о том что Host is up, значит хост машины запущен`

![](img/part4/Screenshot%202024-07-05%20at%2020.03.22.png)

## Part 5. Статическая маршрутизация сети

- `Поднял пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))`
![](img/part5/part5_network.png)

### 5.1. Настройка адресов машин
- `настроил конфигурацию сети согласно рисунку`  

![](img/part5/Screenshot%202024-07-10%20at%2013.25.27.png)

- `с помощью команды ip -4 проверил, что адреса машин заданы верно`  
`ws11`  
![](img/part5/Screenshot%202024-07-10%20at%2013.30.11.png)  
`r1`  
![](img/part5/Screenshot%202024-07-10%20at%2013.30.20.png)  
`r2`  
![](img/part5/Screenshot%202024-07-10%20at%2013.30.28.png)  
`ws22`  
![](img/part5/Screenshot%202024-07-10%20at%2013.30.35.png)  
`ws21`  
![](img/part5/Screenshot%202024-07-10%20at%2013.30.46.png)  
---
`ping ws22 c ws21`  
![](img/part5/Screenshot%202024-07-10%20at%2013.35.53.png)   
`ping r1 c ws11`  
![](img/part5/Screenshot%202024-07-10%20at%2013.36.26.png)

### 5.2. Включение переадресации IP-адресов

`ввод команды sysctl -w net.ipv4.ip_forward=1 на роутерах`  
`При таком подходе переадресация не будет работать после перезагрузки системы`  
![](img/part5/Screenshot%202024-07-10%20at%2013.38.47.png)
![](img/part5/Screenshot%202024-07-10%20at%2013.38.39.png)

---
`добавил в /etc/sysctl.conf следующую строку: net.ipv4.ip_forward = 1`  
`При использовании этого подхода, IP-переадресация включена на постоянной основе` 
![](img/part5/Screenshot%202024-07-10%20at%2013.42.03.png)
![](img/part5/Screenshot%202024-07-10%20at%2013.41.57.png)

### 5.3. Установка маршрута по-умолчанию

`Настроил маршрут по-умолчанию (шлюз) для рабочих станций`  
  
`ws22`  
![](img/part5/Screenshot%202024-07-10%20at%2013.44.00.png)  
`ws21`  
![](img/part5/Screenshot%202024-07-10%20at%2013.44.10.png)  
`ws11`  
![](img/part5/Screenshot%202024-07-10%20at%2013.43.46.png)  

---
`вызов ip r`

`ws11`  
![](img/part5/Screenshot%202024-07-10%20at%2013.47.47.png)
`ws22`  
![](img/part5/Screenshot%202024-07-10%20at%2013.47.53.png)
`ws21`  
![](img/part5/Screenshot%202024-07-10%20at%2013.48.00.png)

`Пингуем с ws11 роутер r2 , пинг доходит`

![](img/part5/Screenshot%202024-07-10%20at%2016.15.36.png)
![](img/part5/Screenshot%202024-07-10%20at%2016.15.59.png)


### 5.4. Добавление статических маршрутов

- `Добавил в роутеры r1 и r2 статические маршруты в файле конфигураций`

![](img/part5/Screenshot%202024-07-10%20at%2017.48.48.png)
![](img/part5/Screenshot%202024-07-10%20at%2017.48.54.png)

- `таблицы с маршрутам`

![](img/part5/Screenshot%202024-07-10%20at%2017.52.09.png)
![](img/part5/Screenshot%202024-07-10%20at%2017.52.17.png)

- `ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0`  

![](img/part5/Screenshot%202024-07-10%20at%2017.58.30.png)

`Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, потому что при наличии нескольких маршрутов одинаковой длины выбирается тот маршрут, который задан наиболее точно`

### 5.5. Построение списка маршрутизаторов

- `Запуск на r1 команды дампа: tcpdump -tnv -i eth0 и построение списка маршрутизаторов на пути от ws11 до ws21 помощи утилиты traceroute`

![](img/part5/Screenshot%202024-07-11%20at%2013.22.33.png)

Для определения промежуточных маршрутизаторов traceroute отправляет целевому узлу серию ICMP-пакетов (по умолчанию 3 пакета), с каждым шагом увеличивая значение поля TTL («время жизни») на 1. Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом. Первая серия пакетов отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно ICMP-сообщение «time exceeded in transit», указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера). Затем traceroute повторяет отправку серии пакетов, но уже с TTL, равным 2, что заставляет первый маршрутизатор уменьшить TTL пакетов на единицу и направить их ко второму маршрутизатору. Второй маршрутизатор, получив пакеты с TTL=1, так же возвращает «time exceeded in transit».

Процесс повторяется до тех пор, пока пакет не достигнет целевого узла. При получении ответа от этого узла процесс трассировки считается завершённым.

На оконечном хосте IP-датаграмма с TTL = 1 не отбрасывается и не вызывает ICMP-сообщения типа срок истёк, а должна быть отдана приложению. Достижение пункта назначения определяется следующим образом: отсылаемые traceroute датаграммы содержат UDP-пакет с заведомо неиспользуемым номером порта на адресуемом хосте. Номер порта будет равен 33434 + (максимальное количество транзитных участков до узла) — 1. В пункте назначения UDP-модуль, получая подобные датаграммы, возвращает ICMP-сообщения об ошибке «порт недоступен». Таким образом, чтобы узнать о завершении работы, программе traceroute достаточно обнаружить, что поступило ICMP-сообщение об ошибке этого типа
### 5.6. Использование протокола ICMP при маршрутизации

`Запуск на r1 перехвата сетевого трафика, проходящего через eth0 с помощью команды:
tcpdump -n -i eth0 icmp`

![](img/part5/Screenshot%202024-07-11%20at%2013.31.09.png)

## Part 6. Динамическая настройка IP с помощью DHCP
`1) Указал адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети у r2`

![](img/part6/Screenshot%202024-07-11%20at%2013.49.32.png)

`2) В файле resolv.conf прописал nameserver 8.8.8.8.`

![](img/part6/Screenshot%202024-07-11%20at%2013.47.46.png)

`Перезагрузил службу DHCP командой systemctl restart isc-dhcp-server. Машину ws21 перезагрузил при помощи reboot. Вывод команды ip a говорит о том что машина получила ip 10.20.0.6 от DHCP сервера`

![](img/part6/Screenshot%202024-07-11%20at%2014.40.23.png)

`пингуем ws22 c ws11`

![](img/part6/Screenshot%202024-07-11%20at%2014.13.00.png)

`добавил MAC адрес у ws11`

![](img/part6/Screenshot%202024-07-11%20at%2014.45.20.png)

`Указал адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети у r1 и сделал выдачу адресов с жесткой привязкой к MAC-адресу (ws11)`

![](img/part6/Screenshot%202024-07-11%20at%2015.47.05.png)

`В файле resolv.conf прописал nameserver 8.8.8.8`

![](img/part6/Screenshot%202024-07-11%20at%2015.34.44.png)

`перезагрузка служб dhcp`

![](img/part6/Screenshot%202024-07-11%20at%2015.50.04.png)

`ip enp0s8 машины ws21 до и после обновления `

![](img/part6/Screenshot%202024-07-11%20at%2015.56.45.png)

`Команда sudo dhclient -r enp0s8 освобождает текущий адрес интерфейса enp0s8. Команда sudo dhclient enp0s8 задает новый адрес указанному интерфейсу`

## Part 7. NAT

`Содержание файла /etc/apache2/ports.conf на ws22 и r1 (строка Listen 80 изменена на Listen 0.0.0.0:80)`

![](img/part7/Screenshot%202024-07-11%20at%2016.25.57.png)

`Запуск веб-сервера Apache командой service apache2 start на ws22 и r1`

![](img/part7/Screenshot%202024-07-11%20at%2016.27.22.png)

`Добавление в фаервол на r2 следующих правил:`  
1) `Удаление правил в таблице filter - iptables -F`  
2) `Удаление правил в таблице "NAT" - iptables -F -t nat`  
3) `Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP` 

![](img/part7/Screenshot%202024-07-11%20at%2016.16.56.png)
 
`запуск фаервола:`

![](img/part7/Screenshot%202024-07-11%20at%2016.17.48.png)

`Проверка соединения между ws22 и r1 командой ping:`

![](img/part7/Screenshot%202024-07-11%20at%2016.32.16.png)

`4) Разрешить маршрутизацию всех пакетов протокола ICMP`

![](img/part7/Screenshot%202024-07-12%20at%2019.37.41.png)

`Проверка соединения между ws22 и r1 командой ping:`

![](img/part7/Screenshot%202024-07-12%20at%2019.43.39.png)

`5) Включил SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2`


`6) Включил DNAT на 8080 порт машины r2 и добавил к веб-серверу Apache, запущенному на ws22, доступ извне сети`

![](img/part7/Screenshot%202024-07-13%20at%2012.13.26.png)

`Проверка соединения по TCP для SNAT, для этого с ws22 нужно подключиться к серверу Apache на r1 командой telnet [адрес] [порт]`

![](img/part7/Screenshot%202024-07-13%20at%2012.18.05.png)

`Проверка соединения по TCP для DNAT: для этого с r1 нужно подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080)`

![](img/part7/Screenshot%202024-07-13%20at%2012.26.52.png)

## Part 8. Дополнительно. Знакомство с SSH Tunnels

`1) Запустил на r2 фаервол с правилами из Части 7`

![](img/part8/Screenshot%202024-07-13%20at%2012.33.35.png)

`2) Запустил веб-сервер Apache на ws22 на localhost`

![](img/part8/Screenshot%202024-07-13%20at%2012.32.05.png)
![](img/part8/Screenshot%202024-07-13%20at%2012.36.22.png)

`3) Запуск Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21.`

![](img/part8/Screenshot%202024-07-13%20at%2013.33.39.png)

`Для Local TCP forwarding применяется команда ssh -L local_port:destination:destination_port ssh_server_ip`

`Проверка подключения:`

![](img/part8/Screenshot%202024-07-13%20at%2013.32.02.png)

`4) Запуск Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11 (прописываем именно с ws22)`

![](img/part8/Screenshot%202024-07-13%20at%2019.02.00.png)

`Для Remote TCP forwarding применяется команда ssh -R remote_port:destination:destination_port ssh_server_ip`

`Проверка подключения:`

![](img/part8/Screenshot%202024-07-13%20at%2019.01.24.png)




